<?php

/**
 * @file
 * Synchronize files with an Amazon S3 bucket across multiple regions.
 */

use Drupal\image\Entity\ImageStyle;

/**
 * Implements hook_file_url_alter().
 */
function amazon_s3_sync_file_url_alter(&$uri) {
  if (preg_match('/^public:\/\/(.*)$/', $uri, $matches)) {
    $path = $matches[1];

    $config = \Drupal::Config('amazon_s3_sync.config');

    if ($config->get('rewrite_url')) {
      $excludes = $config->get('s3cmd_excludes');
      foreach ($excludes as $value) {
        if (fnmatch($value, $path)) {
          return;
        }
      }

      $protocol = ($config->get('enable_ssl')) ? 'https' : 'http';

      $uri = $protocol . '://' . $config->get('endpoint') . '/' . $path;
    }
  }
}

/**
 * Implements hook_entity_delete().
 */
function amazon_s3_sync_entity_delete(Drupal\Core\Entity\EntityInterface $entity) {
  amazon_s3_sync_entity($entity);
}

/**
 * Implements hook_entity_insert().
 */
function amazon_s3_sync_entity_insert(Drupal\Core\Entity\EntityInterface $entity) {
  amazon_s3_sync_entity($entity);
}

/**
 * Implements hook_entity_update().
 */
function amazon_s3_sync_entity_update(Drupal\Core\Entity\EntityInterface $entity) {
  amazon_s3_sync_entity($entity);
}

/**
 * Synchronize file updates with the Amazon S3 bucket(s).
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The entity object.
 */
function amazon_s3_sync_entity(Drupal\Core\Entity\EntityInterface $entity) {
  $fields = array_keys($entity->toArray());
  foreach ($fields as $field_id) {

    // Process entity fields.
    if (preg_match('/^field_/', $field_id)) {
      $field_item = $entity->get($field_id);
      $field_type = $field_item->getFieldDefinition()->getType();

      if ($field_type == 'file') {
        amazon_s3_sync_file($field_item->entity->getFileUri());
      }

      if ($field_type == 'image') {
        $image_styles = \Drupal::service('entity_type.manager')
          ->getStorage('image_style')->loadMultiple();

        // Create image derivatives.
        foreach ($image_styles as $image_style) {
          $original_uri = $field_item->entity->getFileUri();

          $derivative_uri = $image_style->buildUri($original_uri);

          $image_style->createDerivative($original_uri, $derivative_uri);

          amazon_s3_sync_file($derivative_uri);
        }
      }
    }
  }
}

/**
 * Synchronize file updates with the Amazon S3 bucket(s).
 *
 * @param string $uri
 *   Drupal public: file path.
 */
function amazon_s3_sync_file($uri) {
  $config = \Drupal::Config('amazon_s3_sync.config');

  $source = \Drupal::service('file_system')->realpath($uri);

  if (file_exists($source)) {
    $target = file_uri_target($uri);

    // Sync the file using the S3cmd client.
    $s3cmd = \Drupal::service('amazon_s3_sync.s3cmd');
    $s3cmd->dry_run = $config->get('dry_run');
    $s3cmd->debug   = $config->get('debug');
    $s3cmd->verbose = $config->get('verbose');
    $s3cmd->sync($source, $target);
  }
}
